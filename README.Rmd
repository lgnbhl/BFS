---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

<!-- badges: start -->
[![CRAN status](https://www.r-pkg.org/badges/version/BFS)](https://CRAN.R-project.org/package=BFS)
[![Grand total](https://cranlogs.r-pkg.org/badges/grand-total/BFS)](https://cran.r-project.org/package=BFS)
[![R-CMD-check](https://github.com/lgnbhl/BFS/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/lgnbhl/BFS/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

# BFS <img src="man/figures/logo.png" align="right" />

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

> Search and download data from the Swiss Federal Statistical Office

The `BFS` package allows to search and download public data from the 
[Swiss Federal Statistical Office](https://www.pxweb.bfs.admin.ch/pxweb/en/){target="_blank"} (BFS stands for *Bundesamt f√ºr Statistik* in German) API in a dynamic and reproducible way.

## Installation

```{r eval=FALSE}
install.packages("BFS")
```

You can also install the development version from Github.

```{r eval=FALSE}
devtools::install_github("lgnbhl/BFS")
```

## Usage

```{r load BFS}
library(BFS)
```

### Get the data catalog

Retrieve the list of publicly available datasets from the [data catalog](https://www.bfs.admin.ch/bfs/de/home/statistiken/kataloge-datenbanken/daten.html) in any language ("de", "fr", "it" or "en") by calling `bfs_get_catalog_data()`.

```{r}
catalog_data_en <- bfs_get_catalog_data(language = "en")

catalog_data_en
```

English and Italian data catalogs offer a limited list of datasets. For the full list please get the French ("fr") or German ("de") data catalogs.

### Download a dataset in any language

The function `bfs_get_data()` allows you to download any dataset for the data catalog.

To download a specific dataset, you can either use the `url_bfs` or the `number_bfs`.

The `url_bfs` argument refers to the offical webpage of a dataset. Find below an example.

```{r bfs_search}
library(dplyr)

url_bfs_uni_students <- catalog_data_en %>%
  dplyr::filter(title == "University students by year, ISCED field, sex and level of study") %>%
  dplyr::pull(url_bfs)

url_bfs_uni_students
```

Then you can download the full dataset using `url_bfs`.

```{r bfs_get_data}
# https://www.bfs.admin.ch/content/bfs/en/home/statistiken/kataloge-datenbanken/daten.assetdetail.16324907.html
df_uni <- bfs_get_data(url_bfs = url_bfs_uni_students, language = "en")

df_uni
```

It is recommended to privilege the use of the `number_bfs` argument for stability and reproducibility.

You can manually find the `number_bfs` by opening the official webpage and look for the "FSO number".

```{r browseURL, eval=FALSE}
# open Uni students dataset webpage
browseURL(url_bfs_uni_students)
```

<img style="border:1px solid black;" src="https://raw.githubusercontent.com/lgnbhl/BFS/master/man/figures/screenshot.png" align="center" />

<br/>

Then you can download the dataset using `number_bfs`. 

```{r, eval=FALSE}
bfs_get_data(number_bfs = "px-x-1502040100_131", language = "en")
```

You can also access additional information about the dataset by running `bfs_get_data_comments()`.

```{r attributes}
bfs_get_data_comments(number_bfs = "px-x-1502040100_131", language = "en")
```

#### Query specific elements

You may get an error message if the query is too large.

```
Error: 
Too large query. 
The smallest batch size is 24030 and the maximum number of values 
that can be downloaded through the API is 5000.
```

You may also have an error if the API calls too many requests.

```
Error in pxweb_advanced_get(url = url, query = query, verbose = verbose) : 
  Too Many Requests (RFC 6585) (HTTP 429).
```

One solution is to query only specific elements of the dataset to download less data. Here an example.

First you want to get the variable names, i.e. `code`, and categories, i.e. `values`, of your dataset.

```{r}
# choose a BFS number and language
metadata <- bfs_get_metadata(number_bfs = "px-x-1502040100_131", language = "en")

str(metadata)
```

Then you can manually select the dimensions of the dataset you want to query.

```{r}
# Manually create BFS query dimensions
# Use `code` and `values` elements
# Use "*" to select all
dimensions <- list(
  "Jahr" = c("40", "41"),
  "ISCED Fach" = c("0"),
  "Geschlecht" = c("*"),
  "Studienstufe" = c("2", "3"))

# Query BFS data with specific dimensions
BFS::bfs_get_data(
  number_bfs = "px-x-1502040100_131",
  language = "en",
  query = dimensions
  )
```

### Catalog of tables

A lot of tables are not accessible through the official API, but they are still present in the official BFS website. You can access the [RSS feed tables catalog](https://www.bfs.admin.ch/bfs/en/home/statistiken/kataloge-datenbanken/tabellen/_jcr_content/par/ws_catalog.rss.xml?skipLimit=true) using `bfs_get_catalog_tables()`. Most of these tables are Excel or CSV files. Note again that only a part of all the public tables accessible are in the RSS feed (the most recently updated datasets).

```{r}
catalog_tables_en <- bfs_get_catalog_tables(language = "en")

catalog_tables_en
```

```{r}
library(dplyr)
library(openxlsx)

index_table_url <- catalog_tables_en %>%
  filter(grepl("index", title)) %>% # search table
  slice(1) %>%
  pull(url_table)

df <- tryCatch(expr = openxlsx::read.xlsx(index_table_url, startRow = 1),
	error = function(e) "Failed reading table") %>%
  as_tibble()

df
```

## Main dependencies of the package

Under the hood, this package is using extensively the [pxweb](https://ropengov.github.io/pxweb/index.html){target="_blank"} R package to query the Swiss Federal Statistical Office PXWEB API. PXWEB is an API structure developed by Statistics Sweden and other national statistical institutions (NSI) to disseminate public statistics in a structured way.

The list of available datasets is accessed using the [tidyRSS](https://github.com/RobertMyles/tidyRSS){target="_blank"} R package to scrap the official [BFS RSS feed](https://www.bfs.admin.ch/bfs/en/home/statistiken/kataloge-datenbanken/daten/_jcr_content/par/ws_catalog.rss.xml?skipLimit=true). 

You can clean the column names of the datasets automatically using `janitor::clean_names()` by adding the argument `clean_names = TRUE` in the `bfs_get_data()` function. 

## Other information

A [blog article](https://felixluginbuhl.com/blog/posts/2019-11-07-swiss-data/) showing a concrete example about how to use the BFS package and to visualize the data in a Swiss map.

This package is in no way officially related to or endorsed by the Swiss Federal Statistical Office (BFS).

## Contribute

Any contribution is strongly appreciated. Feel free to report a bug, ask any question or make a pull request for any remaining [issue](https://github.com/lgnbhl/BFS/issues).
